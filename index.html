<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
            <script>
                // Firebase configuration - Inserted project config
                const firebaseConfig = {
                    apiKey: "AIzaSyDYP2YBQ-rP1HZbBrmDuqzBBZmMvwtQFnE",
                    authDomain: "milk-calculater-web.firebaseapp.com",
                    projectId: "milk-calculater-web",
                    storageBucket: "milk-calculater-web.firebasestorage.app",
                    messagingSenderId: "806251680205",
                    appId: "1:806251680205:web:dbb3343fcd45b673fcb484",
                    measurementId: "G-LMMCHTPCB1"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();

                // Data Storage (cloud-first). Local arrays are used as UI cache.
                const VENDOR_CREDENTIALS = { name: 'Admin', mobile: '1234567890' };
                let customers = [];
                let milkEntries = [];
                let currentUser = null;

                // Initialize
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('entryDate').valueAsDate = new Date();
                    populateMonthFilters();
                    fetchDataFromCloud();
                });

                async function fetchDataFromCloud() {
                    try {
                        const custSnap = await db.collection('customers').orderBy('createdAt', 'asc').get();
                        customers = custSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        const entrySnap = await db.collection('milkEntries').orderBy('date', 'desc').get();
                        milkEntries = entrySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        updateVendorDashboard();
                        populateCustomerDropdown();
                    } catch (err) {
                        console.error('Error fetching data from cloud:', err);
                        showMessage('loginMessage', 'Failed to load cloud data. Check Firebase config.', 'error');
                    }
                }

                // Login Form
                document.getElementById('loginForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userType = document.getElementById('userType').value;
                    const name = document.getElementById('loginName').value.trim();
                    const mobile = document.getElementById('loginMobile').value.trim();

                    if (userType === 'vendor') {
                        if (name === VENDOR_CREDENTIALS.name && mobile === VENDOR_CREDENTIALS.mobile) {
                            currentUser = { type: 'vendor', name, mobile };
                            showDashboard('vendor');
                        } else {
                            showMessage('loginMessage', 'Invalid vendor credentials', 'error');
                        }
                    } else if (userType === 'customer') {
                        const customer = customers.find(c => c.name === name && c.mobile === mobile);
                        if (customer) {
                            currentUser = { type: 'customer', ...customer };
                            showDashboard('customer');
                        } else {
                            showMessage('loginMessage', 'Customer not found. Please contact vendor.', 'error');
                        }
                    }
                });

                // Add Customer Form (writes to Firestore)
                document.getElementById('addCustomerForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const name = document.getElementById('addCustomerName').value.trim();
                    const mobile = document.getElementById('addCustomerMobile').value.trim();
                    const rate = parseFloat(document.getElementById('addMilkRate').value);

                    if (customers.find(c => c.mobile === mobile)) {
                        showMessage('customerMessage', 'Customer with this mobile number already exists', 'error');
                        return;
                    }

                    try {
                        const docRef = await db.collection('customers').add({ name, mobile, rate, createdAt: new Date().toISOString() });
                        const customer = { id: docRef.id, name, mobile, rate, createdAt: new Date().toISOString() };
                        customers.push(customer);

                        showMessage('customerMessage', 'Customer added successfully!', 'success');
                        this.reset();
                        updateVendorDashboard();
                        populateCustomerDropdown();

                        setTimeout(() => {
                            closeModal('addCustomerModal');
                        }, 1500);
                    } catch (err) {
                        console.error('Add customer failed:', err);
                        showMessage('customerMessage', 'Failed to add customer to cloud', 'error');
                    }
                });

                // Add Entry Form (writes to Firestore)
                document.getElementById('addEntryForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const customerId = document.getElementById('entryCustomer').value; // string id from Firestore
                    const date = document.getElementById('entryDate').value;
                    const session = document.getElementById('entrySession').value;
                    const quantity = parseFloat(document.getElementById('entryQuantity').value);

                    // Check for duplicate entry
                    const duplicate = milkEntries.find(en =>
                        en.customerId === customerId &&
                        en.date === date &&
                        en.session === session
                    );

                    if (duplicate) {
                        showMessage('entryMessage', 'Entry already exists for this date and session', 'error');
                        return;
                    }

                    try {
                        const docRef = await db.collection('milkEntries').add({ customerId, date, session, quantity, createdAt: new Date().toISOString() });
                        const entry = { id: docRef.id, customerId, date, session, quantity, createdAt: new Date().toISOString() };
                        milkEntries.push(entry);

                        showMessage('entryMessage', 'Entry added successfully!', 'success');
                        this.reset();
                        document.getElementById('entryDate').valueAsDate = new Date();
                        updateVendorDashboard();

                        setTimeout(() => {
                            closeModal('addEntryModal');
                        }, 1500);
                    } catch (err) {
                        console.error('Add entry failed:', err);
                        showMessage('entryMessage', 'Failed to add entry to cloud', 'error');
                    }
                });

                function showDashboard(type) {
                    document.getElementById('loginPage').style.display = 'none';
                    if (type === 'vendor') {
                        document.getElementById('vendorDashboard').classList.add('active');
                        document.getElementById('vendorName').textContent = currentUser.name;
                        updateVendorDashboard();
                        populateCustomerDropdown();
                    } else {
                        document.getElementById('customerDashboard').classList.add('active');
                        document.getElementById('customerName').textContent = currentUser.name;
                        updateCustomerDashboard();
                    }
                }

                function updateVendorDashboard() {
                    // Update stats
                    document.getElementById('totalCustomers').textContent = customers.length;

                    const today = new Date().toISOString().split('T')[0];
                    const todayEntries = milkEntries.filter(e => e.date === today);
                    const morningTotal = todayEntries.filter(e => e.session === 'morning')
                        .reduce((sum, e) => sum + e.quantity, 0);
                    const eveningTotal = todayEntries.filter(e => e.session === 'evening')
                        .reduce((sum, e) => sum + e.quantity, 0);

                    document.getElementById('todayMorning').textContent = morningTotal.toFixed(2);
                    document.getElementById('todayEvening').textContent = eveningTotal.toFixed(2);

                    // Update entries table
                    displayVendorEntries();
                }

                function displayVendorEntries(filterMonth = '') {
                    const tbody = document.getElementById('vendorEntriesBody');
                    let entries = [...milkEntries].sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (filterMonth) {
                        entries = entries.filter(e => e.date.startsWith(filterMonth));
                    }

                    entries = entries.slice(0, 50); // Show latest 50 entries

                    tbody.innerHTML = entries.map(entry => {
                        const customer = customers.find(c => c.id === entry.customerId);
                        return `
                            <tr>
                                <td>${formatDate(entry.date)}</td>
                                <td>${customer ? customer.name : 'Unknown'}</td>
                                <td><span class="badge ${entry.session}">${entry.session}</span></td>
                                <td>${entry.quantity} L</td>
                                <td>
                                    <button class="btn-small btn-danger" onclick="deleteEntry('${entry.id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                function updateCustomerDashboard() {
                    const currentMonth = new Date().toISOString().substring(0, 7);
                    filterCustomerEntries(currentMonth);
                }

                function filterCustomerEntries(month) {
                    const selectedMonth = month || document.getElementById('customerMonthFilter').value || new Date().toISOString().substring(0, 7);

                    const customerEntries = milkEntries.filter(e =>
                        e.customerId === currentUser.id &&
                        e.date.startsWith(selectedMonth)
                    );

                    const morningTotal = customerEntries.filter(e => e.session === 'morning')
                        .reduce((sum, e) => sum + e.quantity, 0);
                    const eveningTotal = customerEntries.filter(e => e.session === 'evening')
                        .reduce((sum, e) => sum + e.quantity, 0);
                    const monthTotal = morningTotal + eveningTotal;
                    const totalAmount = monthTotal * currentUser.rate;

                    document.getElementById('customerMonthTotal').textContent = monthTotal.toFixed(2);
                    document.getElementById('customerMorningTotal').textContent = morningTotal.toFixed(2);
                    document.getElementById('customerEveningTotal').textContent = eveningTotal.toFixed(2);

                    // Display monthly summary
                    const summaryDiv = document.getElementById('monthlySummary');
                    summaryDiv.innerHTML = `
                        <div style="padding: 20px; background: var(--bg-light); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <p style="color: var(--text-gray); font-size: 14px;">Total Milk</p>
                                    <p style="font-size: 24px; font-weight: bold; color: var(--primary);">${monthTotal.toFixed(2)} L</p>
                                </div>
                                <div>
                                    <p style="color: var(--text-gray); font-size: 14px;">Rate per Liter</p>
                                    <p style="font-size: 24px; font-weight: bold; color: var(--secondary);">â‚¹${currentUser.rate.toFixed(2)}</p>
                                </div>
                                <div>
                                    <p style="color: var(--text-gray); font-size: 14px;">Total Amount</p>
                                    <p style="font-size: 24px; font-weight: bold; color: var(--success);">â‚¹${totalAmount.toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="border-top: 2px solid var(--border); padding-top: 16px;">
                                <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 8px;">Breakdown:</p>
                                <p style="font-size: 14px;">Morning: ${morningTotal.toFixed(2)} L Ã— â‚¹${currentUser.rate.toFixed(2)} = â‚¹${(morningTotal * currentUser.rate).toFixed(2)}</p>
                                <p style="font-size: 14px;">Evening: ${eveningTotal.toFixed(2)} L Ã— â‚¹${currentUser.rate.toFixed(2)} = â‚¹${(eveningTotal * currentUser.rate).toFixed(2)}</p>
                            </div>
                        </div>
                    `;

                    // Display entries
                    const tbody = document.getElementById('customerEntriesBody');
                    const sortedEntries = customerEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    tbody.innerHTML = sortedEntries.map(entry => `
                        <tr>
                            <td>${formatDate(entry.date)}</td>
                            <td><span class="badge ${entry.session}">${entry.session}</span></td>
                            <td>${entry.quantity} L</td>
                        </tr>
                    `).join('');
                }

                async function deleteEntry(id) {
                    if (confirm('Are you sure you want to delete this entry?')) {
                        try {
                            await db.collection('milkEntries').doc(id).delete();
                            milkEntries = milkEntries.filter(e => e.id !== id);
                            updateVendorDashboard();
                        } catch (err) {
                            console.error('Delete failed:', err);
                            showMessage('loginMessage', 'Failed to delete entry from cloud', 'error');
                        }
                    }
                }

                function showAllCustomers() {
                    const tbody = document.getElementById('vendorEntriesBody');
                    const thead = document.querySelector('#vendorEntriesTable thead tr');
            
                    // Update table header
                    thead.innerHTML = `
                        <th>Customer Name</th>
                        <th>Mobile</th>
                        <th>Total Liters</th>
                        <th>Rate/L</th>
                        <th>Action</th>
                    `;
            
                    // Display all customers
                    tbody.innerHTML = customers.map(customer => {
                        const customerEntries = milkEntries.filter(e => e.customerId === customer.id);
                        const totalLiters = customerEntries.reduce((sum, e) => sum + e.quantity, 0);
                        return `
                            <tr>
                                <td><strong>${customer.name}</strong></td>
                                <td>${customer.mobile}</td>
                                <td>${totalLiters.toFixed(2)} L</td>
                                <td>â‚¹${customer.rate.toFixed(2)}/L</td>
                                <td><button class="btn-small btn-primary" onclick="updateVendorDashboard()">Back</button></td>
                            </tr>
                        `;
                    }).join('');
                }

                function populateCustomerDropdown() {
                    const select = document.getElementById('entryCustomer');
                    select.innerHTML = '<option value="">Select Customer</option>' + 
                        customers.map(c => `<option value="${c.id}">${c.name} - ${c.mobile}</option>`).join('');
                }

                function populateMonthFilters() {
                    const months = [];
                    const now = new Date();
                    for (let i = 0; i < 12; i++) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthStr = date.toISOString().substring(0, 7);
                        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        months.push({ value: monthStr, label: monthName });
                    }
            
                    const vendorFilter = document.getElementById('vendorMonthFilter');
                    const customerFilter = document.getElementById('customerMonthFilter');
            
                    const options = months.map(m => `<option value="${m.value}">${m.label}</option>`).join('');
                    vendorFilter.innerHTML = '<option value="">All Months</option>' + options;
                    customerFilter.innerHTML = '<option value="">Select Month</option>' + options;
            
                    // Set current month as default for customer
                    customerFilter.value = now.toISOString().substring(0, 7);
                }

                function filterVendorEntries() {
                    const month = document.getElementById('vendorMonthFilter').value;
                    displayVendorEntries(month);
                }

                function openModal(modalId) {
                    document.getElementById(modalId).classList.add('active');
                }

                function closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('active');
                    // Clear messages
                    const messageElements = document.querySelectorAll(`#${modalId} .message`);
                    messageElements.forEach(el => el.remove());
                }

                function logout() {
                    currentUser = null;
                    document.getElementById('vendorDashboard').classList.remove('active');
                    document.getElementById('customerDashboard').classList.remove('active');
                    document.getElementById('loginPage').style.display = 'flex';
                    document.getElementById('loginForm').reset();
                }

                function showMessage(elementId, message, type) {
                    const messageDiv = document.getElementById(elementId);
                    messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                }

                function formatDate(dateStr) {
                    const date = new Date(dateStr + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                }

                // Close modals when clicking outside
                window.onclick = function(event) {
                    if (event.target.classList.contains('modal')) {
                        event.target.classList.remove('active');
                    }
                }
            </script>
            color: var(--text-dark);
        }

        .hidden {
            display: none !important;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .month-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.morning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.evening {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .dashboard-header {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>ðŸ¥› Milk Management</h1>
                <p>Track your daily milk deliveries</p>
            </div>
            <div id="loginMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="userType">Login As</label>
                    <select id="userType" required>
                        <option value="">Select Type</option>
                        <option value="vendor">Vendor (Admin)</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="loginName">Name</label>
                    <input type="text" id="loginName" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label for="loginMobile">Mobile Number</label>
                    <input type="tel" id="loginMobile" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Vendor Dashboard -->
    <div id="vendorDashboard" class="dashboard container">
        <div class="dashboard-header">
            <div>
                <h1>Vendor Dashboard</h1>
                <p style="color: var(--text-gray); margin-top: 4px;">Manage your milk business</p>
            </div>
            <div class="user-info">
                <span id="vendorName" style="font-weight: 600;"></span>
                <button class="btn-small btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Today's Morning (L)</h3>
                <div class="value" id="todayMorning">0</div>
            </div>
            <div class="stat-card success">
                <h3>Today's Evening (L)</h3>
                <div class="value" id="todayEvening">0</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Quick Actions</h2>
            </div>
            <div class="form-row">
                <button class="btn btn-primary" onclick="openModal('addCustomerModal')">Add New Customer</button>
                <button class="btn btn-success" onclick="openModal('addEntryModal')">Add Milk Entry</button>
                <button class="btn btn-secondary" onclick="showAllCustomers()">View All Customers</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Recent Entries</h2>
                <select id="vendorMonthFilter" onchange="filterVendorEntries()">
                    <option value="">All Months</option>
                </select>
            </div>
            <div style="overflow-x: auto;">
                <table id="vendorEntriesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Session</th>
                            <th>Quantity (L)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorEntriesBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Customer Dashboard -->
    <div id="customerDashboard" class="dashboard container">
        <div class="dashboard-header">
            <div>
                <h1>My Milk Records</h1>
                <p style="color: var(--text-gray); margin-top: 4px;">Track your daily milk supply</p>
            </div>
            <div class="user-info">
                <span id="customerName" style="font-weight: 600;"></span>
                <button class="btn-small btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>This Month Total (L)</h3>
                <div class="value" id="customerMonthTotal">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Morning Total (L)</h3>
                <div class="value" id="customerMorningTotal">0</div>
            </div>
            <div class="stat-card success">
                <h3>Evening Total (L)</h3>
                <div class="value" id="customerEveningTotal">0</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Monthly Summary</h2>
                <select id="customerMonthFilter" onchange="filterCustomerEntries()">
                    <option value="">Select Month</option>
                </select>
            </div>
            <div id="monthlySummary"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Milk Records</h2>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Session</th>
                            <th>Quantity (L)</th>
                        </tr>
                    </thead>
                    <tbody id="customerEntriesBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <button class="close-modal" onclick="closeModal('addCustomerModal')">&times;</button>
            </div>
            <div id="customerMessage"></div>
            <form id="addCustomerForm">
                <div class="form-group">
                    <label for="addCustomerName">Customer Name</label>
                    <input type="text" id="addCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="addCustomerMobile">Mobile Number</label>
                    <input type="tel" id="addCustomerMobile" pattern="[0-9]{10}" required>
                </div>
                <div class="form-group">
                    <label for="addMilkRate">Rate per Liter (â‚¹)</label>
                    <input type="number" id="addMilkRate" step="0.01" value="50" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Customer</button>
            </form>
        </div>
    </div>

    <!-- Add Entry Modal -->
    <div id="addEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Milk Entry</h2>
                <button class="close-modal" onclick="closeModal('addEntryModal')">&times;</button>
            </div>
            <div id="entryMessage"></div>
            <form id="addEntryForm">
                <div class="form-group">
                    <label for="entryCustomer">Select Customer</label>
                    <select id="entryCustomer" required>
                        <option value="">Select Customer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entryDate">Date</label>
                    <input type="date" id="entryDate" required>
                </div>
                <div class="form-group">
                    <label for="entrySession">Session</label>
                    <select id="entrySession" required>
                        <option value="">Select Session</option>
                        <option value="morning">Morning</option>
                        <option value="evening">Evening</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entryQuantity">Quantity (Liters)</label>
                    <input type="number" id="entryQuantity" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn btn-success">Add Entry</button>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        const VENDOR_CREDENTIALS = {
            name: 'Admin',
            mobile: '1234567890'
        };

        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let milkEntries = JSON.parse(localStorage.getItem('milkEntries')) || [];
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('entryDate').valueAsDate = new Date();
            populateMonthFilters();
        });

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const userType = document.getElementById('userType').value;
            const name = document.getElementById('loginName').value.trim();
            const mobile = document.getElementById('loginMobile').value.trim();

            if (userType === 'vendor') {
                if (name === VENDOR_CREDENTIALS.name && mobile === VENDOR_CREDENTIALS.mobile) {
                    currentUser = { type: 'vendor', name, mobile };
                    showDashboard('vendor');
                } else {
                    showMessage('loginMessage', 'Invalid vendor credentials', 'error');
                }
            } else if (userType === 'customer') {
                const customer = customers.find(c => c.name === name && c.mobile === mobile);
                if (customer) {
                    currentUser = { type: 'customer', ...customer };
                    showDashboard('customer');
                } else {
                    showMessage('loginMessage', 'Customer not found. Please contact vendor.', 'error');
                }
            }
        });

        // Add Customer Form
        document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('addCustomerName').value.trim();
            const mobile = document.getElementById('addCustomerMobile').value.trim();
            const rate = parseFloat(document.getElementById('addMilkRate').value);

            if (customers.find(c => c.mobile === mobile)) {
                showMessage('customerMessage', 'Customer with this mobile number already exists', 'error');
                return;
            }

            const customer = {
                id: Date.now(),
                name,
                mobile,
                rate,
                createdAt: new Date().toISOString()
            };

            customers.push(customer);
            localStorage.setItem('customers', JSON.stringify(customers));
            
            showMessage('customerMessage', 'Customer added successfully!', 'success');
            this.reset();
            updateVendorDashboard();
            populateCustomerDropdown();
            
            setTimeout(() => {
                closeModal('addCustomerModal');
            }, 1500);
        });

        // Add Entry Form
        document.getElementById('addEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const customerId = parseInt(document.getElementById('entryCustomer').value);
            const date = document.getElementById('entryDate').value;
            const session = document.getElementById('entrySession').value;
            const quantity = parseFloat(document.getElementById('entryQuantity').value);

            // Check for duplicate entry
            const duplicate = milkEntries.find(e => 
                e.customerId === customerId && 
                e.date === date && 
                e.session === session
            );

            if (duplicate) {
                showMessage('entryMessage', 'Entry already exists for this date and session', 'error');
                return;
            }

            const entry = {
                id: Date.now(),
                customerId,
                date,
                session,
                quantity,
                createdAt: new Date().toISOString()
            };

            milkEntries.push(entry);
            localStorage.setItem('milkEntries', JSON.stringify(milkEntries));
            
            showMessage('entryMessage', 'Entry added successfully!', 'success');
            this.reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            updateVendorDashboard();
            
            setTimeout(() => {
                closeModal('addEntryModal');
            }, 1500);
        });

        function showDashboard(type) {
            document.getElementById('loginPage').style.display = 'none';
            if (type === 'vendor') {
                document.getElementById('vendorDashboard').classList.add('active');
                document.getElementById('vendorName').textContent = currentUser.name;
                updateVendorDashboard();
                populateCustomerDropdown();
            } else {
                document.getElementById('customerDashboard').classList.add('active');
                document.getElementById('customerName').textContent = currentUser.name;
                updateCustomerDashboard();
            }
        }

        function updateVendorDashboard() {
            // Update stats
            document.getElementById('totalCustomers').textContent = customers.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = milkEntries.filter(e => e.date === today);
            const morningTotal = todayEntries.filter(e => e.session === 'morning')
                .reduce((sum, e) => sum + e.quantity, 0);
            const eveningTotal = todayEntries.filter(e => e.session === 'evening')
                .reduce((sum, e) => sum + e.quantity, 0);
            
            document.getElementById('todayMorning').textContent = morningTotal.toFixed(2);
            document.getElementById('todayEvening').textContent = eveningTotal.toFixed(2);
            
            // Update entries table
            displayVendorEntries();
        }

        function displayVendorEntries(filterMonth = '') {
            const tbody = document.getElementById('vendorEntriesBody');
            let entries = [...milkEntries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filterMonth) {
                entries = entries.filter(e => e.date.startsWith(filterMonth));
            }
            
            entries = entries.slice(0, 50); // Show latest 50 entries
            
            tbody.innerHTML = entries.map(entry => {
                const customer = customers.find(c => c.id === entry.customerId);
                return `
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${customer ? customer.name : 'Unknown'}</td>
                        <td><span class="badge ${entry.session}">${entry.session}</span></td>
                        <td>${entry.quantity} L</td>
                        <td>
                            <button class="btn-small btn-danger" onclick="deleteEntry(${entry.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateCustomerDashboard() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            filterCustomerEntries(currentMonth);
        }

        function filterCustomerEntries(month) {
            const selectedMonth = month || document.getElementById('customerMonthFilter').value || new Date().toISOString().substring(0, 7);
            
            const customerEntries = milkEntries.filter(e => 
                e.customerId === currentUser.id && 
                e.date.startsWith(selectedMonth)
            );

            const morningTotal = customerEntries.filter(e => e.session === 'morning')
                .reduce((sum, e) => sum + e.quantity, 0);
            const eveningTotal = customerEntries.filter(e => e.session === 'evening')
                .reduce((sum, e) => sum + e.quantity, 0);
            const monthTotal = morningTotal + eveningTotal;
            const totalAmount = monthTotal * currentUser.rate;

            document.getElementById('customerMonthTotal').textContent = monthTotal.toFixed(2);
            document.getElementById('customerMorningTotal').textContent = morningTotal.toFixed(2);
            document.getElementById('customerEveningTotal').textContent = eveningTotal.toFixed(2);

            // Display monthly summary
            const summaryDiv = document.getElementById('monthlySummary');
            summaryDiv.innerHTML = `
                <div style="padding: 20px; background: var(--bg-light); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <p style="color: var(--text-gray); font-size: 14px;">Total Milk</p>
                            <p style="font-size: 24px; font-weight: bold; color: var(--primary);">${monthTotal.toFixed(2)} L</p>
                        </div>
                        <div>
                            <p style="color: var(--text-gray); font-size: 14px;">Rate per Liter</p>
                            <p style="font-size: 24px; font-weight: bold; color: var(--secondary);">â‚¹${currentUser.rate.toFixed(2)}</p>
                        </div>
                        <div>
                            <p style="color: var(--text-gray); font-size: 14px;">Total Amount</p>
                            <p style="font-size: 24px; font-weight: bold; color: var(--success);">â‚¹${totalAmount.toFixed(2)}</p>
                        </div>
                    </div>
                    <div style="border-top: 2px solid var(--border); padding-top: 16px;">
                        <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 8px;">Breakdown:</p>
                        <p style="font-size: 14px;">Morning: ${morningTotal.toFixed(2)} L Ã— â‚¹${currentUser.rate.toFixed(2)} = â‚¹${(morningTotal * currentUser.rate).toFixed(2)}</p>
                        <p style="font-size: 14px;">Evening: ${eveningTotal.toFixed(2)} L Ã— â‚¹${currentUser.rate.toFixed(2)} = â‚¹${(eveningTotal * currentUser.rate).toFixed(2)}</p>
                    </div>
                </div>
            `;

            // Display entries
            const tbody = document.getElementById('customerEntriesBody');
            const sortedEntries = customerEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedEntries.map(entry => `
                <tr>
                    <td>${formatDate(entry.date)}</td>
                    <td><span class="badge ${entry.session}">${entry.session}</span></td>
                    <td>${entry.quantity} L</td>
                </tr>
            `).join('');
        }

        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                milkEntries = milkEntries.filter(e => e.id !== id);
                localStorage.setItem('milkEntries', JSON.stringify(milkEntries));
                updateVendorDashboard();
            }
        }

        function showAllCustomers() {
            const tbody = document.getElementById('vendorEntriesBody');
            const thead = document.querySelector('#vendorEntriesTable thead tr');
            
            // Update table header
            thead.innerHTML = `
                <th>Customer Name</th>
                <th>Mobile</th>
                <th>Total Liters</th>
                <th>Rate/L</th>
                <th>Action</th>
            `;
            
            // Display all customers
            tbody.innerHTML = customers.map(customer => {
                const customerEntries = milkEntries.filter(e => e.customerId === customer.id);
                const totalLiters = customerEntries.reduce((sum, e) => sum + e.quantity, 0);
                return `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td>${customer.mobile}</td>
                        <td>${totalLiters.toFixed(2)} L</td>
                        <td>â‚¹${customer.rate.toFixed(2)}/L</td>
                        <td><button class="btn-small btn-primary" onclick="updateVendorDashboard()">Back</button></td>
                    </tr>
                `;
            }).join('');
        }

        function populateCustomerDropdown() {
            const select = document.getElementById('entryCustomer');
            select.innerHTML = '<option value="">Select Customer</option>' + 
                customers.map(c => `<option value="${c.id}">${c.name} - ${c.mobile}</option>`).join('');
        }

        function populateMonthFilters() {
            const months = [];
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStr = date.toISOString().substring(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value: monthStr, label: monthName });
            }
            
            const vendorFilter = document.getElementById('vendorMonthFilter');
            const customerFilter = document.getElementById('customerMonthFilter');
            
            const options = months.map(m => `<option value="${m.value}">${m.label}</option>`).join('');
            vendorFilter.innerHTML = '<option value="">All Months</option>' + options;
            customerFilter.innerHTML = '<option value="">Select Month</option>' + options;
            
            // Set current month as default for customer
            customerFilter.value = now.toISOString().substring(0, 7);
        }

        function filterVendorEntries() {
            const month = document.getElementById('vendorMonthFilter').value;
            displayVendorEntries(month);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear messages
            const messageElements = document.querySelectorAll(`#${modalId} .message`);
            messageElements.forEach(el => el.remove());
        }

        function logout() {
            currentUser = null;
            document.getElementById('vendorDashboard').classList.remove('active');
            document.getElementById('customerDashboard').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginForm').reset();
        }

        function showMessage(elementId, message, type) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>